import{j as _}from"./jsx-runtime-BdivIsZm.js";import{r as n}from"./vendor-CIaSNbmr.js";const v=n.createContext(null),b=()=>{const t=n.useContext(v);if(!t)throw new Error("useWorkspace must be used within a WorkspaceContextProvider");return t},y=async t=>{try{localStorage.setItem(`workspace_${t.workspace.id}`,JSON.stringify({state:t.state,settings:t.settings,lastAccessed:new Date().toISOString()}))}catch(r){console.error("Failed to save context state:",r)}},I=async(t,r)=>{try{const a=localStorage.getItem(`workspace_${t.id}`),d=a?JSON.parse(a):{};return{workspace:{...t,state:{...t.state,...d.state,lastAccessed:new Date},settings:{...t.settings,...d.settings}},user:r,permissions:[],roles:r.roles,settings:t.settings,state:t.state,hasPermission:()=>!1,switchContext:async()=>{}}}catch(a){throw console.error("Failed to load workspace context:",a),a}},W=(t,r)=>{const a=setInterval(()=>{Math.random()>.95&&r({workspaceId:t,changes:{state:{lastAccessed:new Date}}})},5e3);return()=>clearInterval(a)},A=({workspace:t,user:r,permissions:a,onContextChange:d,onPermissionDenied:m,children:x,securityMode:h="strict",auditEnabled:i=!0})=>{const[s,f]=n.useState({workspace:t,user:r,permissions:a,roles:r.roles,settings:t.settings,state:t.state,hasPermission:()=>!1,switchContext:async()=>{}}),[p,g]=n.useState([]),l=n.useCallback(e=>{const o=s.permissions.includes(e)||h==="permissive"&&s.roles.includes("admin");if(i){const c={id:`audit_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date,user:s.user,action:"permission_check",resource:e,details:{hasAccess:o,securityMode:h},workspaceId:s.workspace.id,severity:o?"low":"medium"};g(u=>[c,...u.slice(0,99)])}return o||m==null||m(e),o},[s.permissions,s.roles,s.user,s.workspace.id,h,i,m]),w=n.useCallback(async e=>{try{if(!l("workspace:switch"))throw new Error("Permission denied: workspace:switch");await y(s);const c={...await I(e,r),hasPermission:l,switchContext:w};if(f(c),d==null||d(c),i){const u={id:`audit_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date,user:s.user,action:"context_switch",resource:"workspace",details:{fromWorkspace:t.id,toWorkspace:e.id},workspaceId:e.id,severity:"medium"};g(S=>[u,...S.slice(0,99)])}}catch(o){if(console.error("Context switch failed:",o),i){const c={id:`audit_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date,user:s.user,action:"context_switch_failed",resource:"workspace",details:{error:o instanceof Error?o.message:"Unknown error",fromWorkspace:t.id,toWorkspace:e.id},workspaceId:t.id,severity:"high"};g(u=>[c,...u.slice(0,99)])}throw o}},[s,l,r,t.id,i,d]);n.useEffect(()=>{const e=c=>{c.workspaceId===t.id&&f(u=>({...u,...c.changes}))};return W(t.id,e)},[t.id]),n.useEffect(()=>{f(e=>({...e,hasPermission:l,switchContext:w,auditLog:i?p:void 0}))},[l,w,p,i]);const k={...s,hasPermission:l,switchContext:w,auditLog:i?p:void 0};return _.jsx(v.Provider,{value:k,children:x})};export{A as W,b as u};
